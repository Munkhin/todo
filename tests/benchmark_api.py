import asyncio
import aiohttp
import time
import sys
import os
from datetime import datetime, timedelta, timezone

# Add project root to path
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# Import database functions directly to seed data
from api.database import create_task, get_user_by_id

async def benchmark_tasks(base_url, user_id, num_requests=50):
    print(f"\n--- Benchmarking GET /tasks ({num_requests} concurrent requests) ---")
    async with aiohttp.ClientSession() as session:
        start_time = time.time()
        tasks = []
        for _ in range(num_requests):
            tasks.append(session.get(f"{base_url}/tasks?user_id={user_id}"))
        
        responses = await asyncio.gather(*tasks)
        end_time = time.time()
        
        success_count = sum(1 for r in responses if r.status == 200)
        duration = end_time - start_time
        print(f"Total time: {duration:.2f}s")
        print(f"Requests/sec: {num_requests / duration:.2f}")
        print(f"Success rate: {success_count}/{num_requests}")
        
        if success_count < num_requests:
            print("Errors encountered:")
            for r in responses:
                if r.status != 200:
                    print(f"Status {r.status}: {await r.text()}")

async def benchmark_chat(base_url, user_id):
    print(f"\n--- Benchmarking POST /chat (Latency) ---")
    # Simple chat request that shouldn't trigger heavy logic but exercises the agent
    payload = {
        "user_id": str(user_id),
        "text": "Hello, are you working?"
    }
    
    async with aiohttp.ClientSession() as session:
        start_time = time.time()
        try:
            async with session.post(f"{base_url}/chat", json=payload) as response:
                text = await response.text()
                end_time = time.time()

                print(f"Latency: {end_time - start_time:.2f}s")
                print(f"Status: {response.status}")
                preview = text if len(text) <= 200 else text[:200] + "..."
                print(f"Response body: {preview}")
        except Exception as e:
            print(f"Chat benchmark failed: {e}")

async def main():
    # Setup
    print("Setting up benchmark data...")
    try:
        user_id = int(os.getenv("BENCHMARK_USER_ID", "5"))
        user = get_user_by_id(user_id)
        if not user:
            raise ValueError(f"Benchmark user_id {user_id} does not exist in Supabase")
        # Create some tasks to fetch
        for i in range(5):
            due_date = (datetime.now(timezone.utc) + timedelta(days=7 + i)).isoformat()
            create_task({
                "user_id": user_id,
                "title": f"Benchmark Task {i}",
                "description": "Autogenerated benchmark seed task",
                "status": "pending",
                "estimated_duration": 30,
                "difficulty": 3,
                "priority": "medium",
                "due_date": due_date
            })
    except Exception as e:
        print(f"Setup failed: {e}")
        return

    base_url = os.getenv("BENCHMARK_BASE_URL", "http://localhost:8000/api")
    
    print(f"Starting benchmark for user_id: {user_id}")
    
    # Run benchmarks
    await benchmark_tasks(base_url, user_id, num_requests=50)
    await benchmark_chat(base_url, user_id)

if __name__ == "__main__":
    asyncio.run(main())
