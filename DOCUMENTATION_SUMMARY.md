# Complete Flow Documentation Summary

This directory now contains comprehensive documentation of the chat-to-calendar flow in the Todo application. Three detailed documents have been created to help understand how user messages flow through the AI agent system and result in calendar events.

## Documents Created

### 1. CHAT_TO_CALENDAR_FLOW.md (1095 lines)
**Most detailed reference document - READ THIS FIRST**

Complete end-to-end trace with exact file paths and line numbers.

Contents:
- Part 1: Frontend chat input submission
- Part 2: API call to backend
- Part 3: Backend chat message handler
- Part 4: AI agent execution with tool definitions
- Part 5: Tool execution details (create_tasks, schedule_all_tasks, scheduler)
- Part 6: Event return path to frontend
- Part 7: Frontend response handling and calendar refresh
- Part 8: Data fetching from backend
- Part 9: State management with Zustand stores
- Part 10: Calendar rendering logic
- Part 11: Complete data flow summary
- Database models and relationships
- Critical functions with file locations
- API response examples

**Best for:** Understanding the complete journey, deep technical analysis, debugging

### 2. CHAT_FLOW_QUICK_REFERENCE.md (244 lines)
**Quick lookup guide - READ THIS FOR QUICK ANSWERS**

Condensed version with ASCII diagrams for rapid understanding.

Contents:
- Step-by-step breakdown (8 steps)
- File map with directory structure
- Key models (Task, CalendarEvent, EnergyProfile)
- Key metrics and pixel calculations
- Critical path summary
- Important notes

**Best for:** Quick lookups, understanding general flow, finding files, getting started

### 3. FLOW_DIAGRAMS.md (483 lines)
**Visual representations - READ THIS FOR ARCHITECTURE UNDERSTANDING**

ASCII art diagrams and visual flows.

Contents:
1. High-level architecture diagram
2. Message flow sequence diagram
3. Scheduler task assignment flow
4. Event model to calendar display
5. Database relationships
6. Frontend state management
7. Calendar rendering pipeline
8. Event type color/display mapping

**Best for:** Visual learners, architecture overview, understanding relationships

## Quick Start Guide

### For New Developers
1. Start with **CHAT_FLOW_QUICK_REFERENCE.md**
2. Study the critical path summary
3. Review the file map
4. Read **FLOW_DIAGRAMS.md** sections 1-2

### For Understanding Scheduling
1. Read **CHAT_TO_CALENDAR_FLOW.md** Part 5
2. Review **FLOW_DIAGRAMS.md** section 3
3. Examine `/workspaces/todo/api/services/scheduler.py`

### For Frontend Integration
1. Read **CHAT_TO_CALENDAR_FLOW.md** Parts 7-10
2. Review **FLOW_DIAGRAMS.md** sections 6-7
3. Examine `/workspaces/todo/todo_ui/components/Dashboard/ScheduleView.tsx`

### For Agent/Tool Development
1. Read **CHAT_TO_CALENDAR_FLOW.md** Parts 4-5
2. Review **CHAT_FLOW_QUICK_REFERENCE.md** Tools section
3. Examine `/workspaces/todo/api/agent.py` and `/workspaces/todo/api/services/agent_tools.py`

## Key Files Referenced

### Critical Backend Files
```
/workspaces/todo/api/
  ├─ main.py                          - FastAPI app entry point
  ├─ agent.py                         - AI agent with tool execution
  ├─ models.py                        - Database models
  ├─ database.py                      - Database setup
  └─ routes/
      ├─ chat_routes.py               - POST /api/chat/message
      ├─ task_routes.py               - GET /api/tasks
      ├─ calendar_routes.py           - GET /api/calendar/events
      └─ schedule_routes.py
  └─ services/
      ├─ agent_tools.py               - Tool implementations
      └─ scheduler.py                 - Core scheduling logic
```

### Critical Frontend Files
```
/workspaces/todo/todo_ui/
  ├─ app/dashboard/schedule/page.tsx
  ├─ components/Dashboard/
  │   └─ ScheduleView.tsx             - Main component
  └─ lib/
      ├─ store/
      │   ├─ useTaskStore.ts
      │   ├─ useScheduleStore.ts
      │   └─ useChatStore.ts
      └─ api/
          ├─ chat.ts
          ├─ tasks.ts
          └─ calendar.ts
```

## Key Concepts

### The Critical Path
```
User Message
    ↓
Agent Tool: schedule_all_tasks
    ↓
scheduler.reschedule_optimistic()
    ↓
Create CalendarEvent (source="system")
    ↓
Return ORM objects to agent
    ↓
Serialize to JSON response
    ↓
Frontend refreshViewData()
    ↓
Calendar renders tasks/events
```

### Important Distinctions
- **Task**: Database record with topic, due_date, scheduled_start/end
- **CalendarEvent**: Scheduled time block linked to task or standalone
- **source="system"**: Auto-generated by scheduler
- **source="user"**: Manually created by user
- **event_type**: "study" (task), "break" (short), "rest" (long)

### Core Libraries & Patterns
- **Frontend State**: Zustand (not Redux)
- **Frontend Framework**: Next.js with React
- **Backend Framework**: FastAPI
- **Database**: SQLite
- **AI Integration**: OpenAI GPT-4-mini with function calling
- **Scheduling Algorithm**: Energy-aware task assignment with break insertion

## Visual Reference

### Pixel Calculations
```
PX_PER_HOUR = 48 pixels
PX_PER_MIN = 0.8 pixels
top = (minutes_from_wake_time) * 0.8
height = (duration_minutes) * 0.8
```

### Database Relationships
```
User (1)
  ├─ Task (Many)
  ├─ CalendarEvent (Many) ← FK: task_id
  ├─ EnergyProfile (1)
  └─ BrainDump (Many)
```

### Event Flow Timeline
```
Chat input (10ms)
    ↓
Network + OpenAI (1500-2000ms)
    ↓
Tool execution (100-300ms)
    ↓
Scheduler (50-200ms)
    ↓
Response serialize (10ms)
    ↓
Network return (100ms)
    ↓
Frontend refresh (300-500ms)
    ↓
Calendar render (50-100ms)
Total: 2-3 seconds
```

## Common Modifications

### Adding a New Tool
1. Define tool schema in `agent.py` lines 85-244
2. Add to `get_tool_mapping()` in `agent.py`
3. Implement function in `agent_tools.py`
4. Tool receives user_id and db session
5. Return dict with results or error

### Modifying Scheduling Logic
1. Edit `scheduler.reschedule_optimistic()` in `scheduler.py`
2. All CalendarEvent creation happens here
3. Remember to `db.add()` each event
4. Return events in result dict

### Changing Frontend Display
1. Edit rendering code in `ScheduleView.tsx` lines 126-449
2. `getEventBox()` calculates positions
3. `taskToSpan()` extracts times from task
4. Use `PX_PER_MIN` constant for pixel math

## Documentation Maintenance

These documents should be updated when:
- New API endpoints are added (update CHAT_TO_CALENDAR_FLOW.md Part 8)
- New tools are created (update CHAT_TO_CALENDAR_FLOW.md Part 4-5)
- Scheduler logic changes (update FLOW_DIAGRAMS.md section 3)
- Frontend components are refactored (update CHAT_TO_CALENDAR_FLOW.md Part 10)
- Database models change (update all docs)

## Version Information

- Created: 2025-11-04
- Based on codebase state: main branch (commit 641bc0e)
- Frontend: Next.js with React, Zustand
- Backend: FastAPI, SQLite
- AI: OpenAI GPT-4-mini with function calling
- Scheduler: Energy-aware with break insertion

## Quick Troubleshooting

**Events not showing on calendar?**
- Check useScheduleStore.events has data
- Verify fetchEvents() was called after chat
- Check CalendarEvent.source and date range

**Tasks not scheduling?**
- Check EnergyProfile settings (wake_time, sleep_time)
- Verify credit_limits if subscription plan restricted
- Check scheduler conflicts detection

**Agent not responding?**
- Check conversation_store is populated
- Verify OpenAI API key in .env
- Review agent.py system instructions

**Drag/drop not working?**
- Check task has scheduled_start and scheduled_end
- Verify editTask() in store is called
- Check refreshViewData() completes

---

For detailed technical information, refer to the specific documents above.
